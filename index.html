<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory Explorer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.tailwindcss.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* Mobile & Base Styles */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; -webkit-tap-highlight-color: transparent; }
        
        /* Smooth Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top: 3px solid #2563eb; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Cards */
        .item-card { transition: transform 0.2s; border: 1px solid #e2e8f0; }
        .item-card:active { transform: scale(0.98); }
        @media(min-width: 768px) { .item-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); border-color: #3b82f6; } }

        /* Status Pills */
        .pill { padding: 2px 8px; border-radius: 999px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; display: inline-block; white-space: nowrap; }
        .pill-active { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .pill-inactive { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        /* DataTables Customization */
        .dt-buttons .dt-button { background: white !important; color: #475569 !important; border: 1px solid #e2e8f0 !important; border-radius: 0.5rem !important; font-size: 0.875rem !important; padding: 0.5rem 1rem !important; margin-right: 0.5rem !important; transition: all 0.2s; }
        .dt-buttons .dt-button:hover { background: #f1f5f9 !important; border-color: #cbd5e1 !important; }
        .dataTables_filter input { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; outline: none; width: 100%; max-width: 300px; }
        
        /* Modal Transitions */
        .modal { transition: opacity 0.2s ease-in-out; }
        .modal-scale { transition: transform 0.2s ease-in-out; }
        
        /* Mobile Tweaks */
        @media (max-width: 640px) {
            .dt-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
            .dataTables_wrapper .dataTables_filter { float: none; text-align: left; margin-bottom: 1rem; }
            .dataTables_wrapper .dataTables_filter input { width: 100%; margin-left: 0; }
            #btn-group { width: 100%; }
            #btn-group button { flex: 1; justify-content: center; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="loader">
        <div class="spinner mb-4"></div>
        <h2 class="text-lg font-bold text-slate-800">Loading Data...</h2>
        <div id="error-msg" class="hidden mt-6 w-11/12 max-w-sm bg-red-50 p-6 rounded-xl text-center border border-red-100 shadow-sm">
            <i class="fa-solid fa-triangle-exclamation text-xl text-red-500 mb-2"></i>
            <p class="font-bold text-red-700">File Not Found</p>
            <p class="text-xs text-red-600 mt-1">Please ensure <strong>RM.xlsx</strong> is in the repo.</p>
            <label class="block mt-4 cursor-pointer active:scale-95 transition-transform">
                <input type="file" id="manualFileInput" class="hidden" accept=".xlsx, .xls, .csv">
                <span class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md block w-full">
                    Select File Manually
                </span>
            </label>
        </div>
    </div>

    <div id="detailModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="bg-white w-full max-w-4xl sm:rounded-2xl rounded-t-2xl shadow-2xl relative flex flex-col max-h-[95vh] sm:max-h-[85vh] z-10 transform translate-y-10 sm:scale-95 modal-scale" id="modalPanel">
            
            <div class="p-4 sm:p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50 sm:rounded-t-2xl">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span id="modalId" class="text-[10px] font-mono bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded">ID</span>
                        <span id="modalStatus" class="text-[10px] font-bold uppercase tracking-wider"></span>
                    </div>
                    <h3 id="modalTitle" class="text-lg sm:text-2xl font-bold text-slate-800 leading-tight pr-4">Item Name</h3>
                    <div id="modalSubtitle" class="text-xs sm:text-sm text-blue-600 font-medium mt-1">Vendor</div>
                </div>
                <button onclick="closeModal()" class="bg-slate-100 p-2 rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 transition-colors">
                    <i class="fa-solid fa-xmark fa-lg"></i>
                </button>
            </div>

            <div class="p-4 sm:p-8 overflow-y-auto bg-white custom-scrollbar flex-grow">
                
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <p class="text-[10px] font-bold text-blue-400 uppercase">Code</p>
                        <p class="text-sm font-bold text-blue-900 font-mono break-all" id="modalCode">-</p>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Category</p>
                        <p class="text-sm font-bold text-slate-800" id="modalCat">-</p>
                    </div>
                    <div class="hidden sm:block bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Product Code</p>
                        <p class="text-sm font-bold text-slate-800 font-mono" id="modalPCode">-</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-xs font-bold text-slate-900 uppercase tracking-wide mb-2">Remarks</h4>
                    <div class="bg-amber-50 border border-amber-100 rounded-lg p-3">
                        <p id="modalRemarks" class="text-slate-700 text-sm italic">None</p>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold text-slate-900 uppercase tracking-wide mb-3">Full Data Sheet</h4>
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <table class="w-full text-xs sm:text-sm text-left">
                            <tbody id="modalFullTable" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50 sm:rounded-b-2xl flex justify-end">
                <button onclick="closeModal()" class="w-full sm:w-auto bg-slate-200 hover:bg-slate-300 text-slate-800 px-6 py-3 rounded-xl font-bold text-sm transition-colors active:scale-95">Close Details</button>
            </div>
        </div>
    </div>

    <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm safe-area-top">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center shadow-sm">
                    <i class="fa-solid fa-cube text-sm"></i>
                </div>
                <h1 class="font-bold text-lg text-slate-800">Inventory</h1>
            </div>
            
            <div class="flex items-center gap-2" id="btn-group">
                <button onclick="switchView('table')" id="btn-table" class="p-2 rounded-lg text-slate-500 hover:bg-slate-50 transition-colors">
                    <i class="fa-solid fa-list-ul text-lg"></i>
                </button>
                <button onclick="switchView('grid')" id="btn-grid" class="p-2 rounded-lg text-blue-600 bg-blue-50 transition-colors">
                    <i class="fa-solid fa-grid-2 text-lg"></i>
                </button>
                <button onclick="location.reload()" class="ml-2 p-2 rounded-lg text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex-grow">

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Total</p>
                <h3 class="text-2xl font-bold text-slate-800" id="kpi-total">-</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 border-l-4 border-l-green-500">
                <p class="text-[10px] font-bold text-green-600 uppercase">Active</p>
                <h3 class="text-2xl font-bold text-slate-800" id="kpi-active">-</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 border-l-4 border-l-red-500">
                <p class="text-[10px] font-bold text-red-600 uppercase">Inactive</p>
                <h3 class="text-2xl font-bold text-slate-800" id="kpi-inactive">-</h3>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <p class="text-[10px] font-bold text-blue-500 uppercase">Vendors</p>
                <h3 class="text-2xl font-bold text-slate-800" id="kpi-vendors">-</h3>
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4 sticky top-16 z-30 mx-[-4px] sm:mx-0">
            <div class="relative w-full">
                <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-400"></i>
                <input type="text" id="globalSearch" placeholder="Search anything..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none transition-shadow">
            </div>
        </div>

        <div id="tableView" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hidden">
            <div class="p-2 overflow-x-auto">
                <table id="mainTable" class="w-full text-left text-sm border-collapse" style="width:100%">
                    </table>
            </div>
        </div>

        <div id="gridView" class="">
            <div id="gridContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="noResults" class="hidden text-center py-12 text-slate-400">
                <i class="fa-solid fa-ghost text-4xl mb-3"></i>
                <p>No matches found.</p>
            </div>
        </div>

    </main>

    <script>
        const FILENAME = 'RM.xlsx';
        let rawData = [];
        let dataTableInst = null;
        let loadTimeout;
        const DEFAULT_COLS = ['Status', 'Item_Code', 'Item_Name', 'Material List::Material_Detail', 'Vendor List 2::Vendor_Name'];

        $(document).ready(function() {
            // Mobile Optimization: Check width
            if($(window).width() < 768) {
                switchView('grid'); // Force grid on mobile
            } else {
                switchView('table'); // Table on desktop
            }

            attemptFetch();

            $('#globalSearch').on('keyup', function() {
                const val = this.value;
                if(dataTableInst) dataTableInst.search(val).draw();
                filterGrid(val);
            });

            $('#manualFileInput').on('change', function(e) {
                if(e.target.files[0]) processFile(e.target.files[0]);
            });
        });

        function attemptFetch() {
            loadTimeout = setTimeout(() => { showError(); }, 2500);
            fetch(FILENAME + '?v=' + new Date().getTime())
                .then(res => {
                    if(!res.ok) throw new Error("404");
                    return res.arrayBuffer();
                })
                .then(ab => {
                    clearTimeout(loadTimeout);
                    const wb = XLSX.read(ab, {type:'array'});
                    processData(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
                })
                .catch(err => console.error(err));
        }

        function showError() {
            $('#loader .spinner').hide(); $('#loader h2').hide();
            $('#error-msg').removeClass('hidden');
        }

        function processFile(file) {
            const r = new FileReader();
            r.onload = e => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                processData(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
            };
            r.readAsArrayBuffer(file);
        }

        function processData(json) {
            rawData = json;
            if(!rawData || rawData.length === 0) { alert("Empty File"); return; }
            
            // Normalize Keys for consistency
            rawData = rawData.map(row => {
                const newRow = {};
                Object.keys(row).forEach(key => {
                    // Create a cleaner key mapping if needed, but keeping original for "Explore" mode
                    newRow[key] = row[key]; 
                });
                return newRow;
            });

            renderDashboard();
            $('#loader').fadeOut();
        }

        function renderDashboard() {
            let active = 0, discontinued = 0;
            let vendors = new Set();
            
            // 1. Prepare Grid
            const grid = $('#gridContainer').empty();
            
            // 2. Prepare Table Columns Dynamically
            const allKeys = Object.keys(rawData[0]);
            
            // Identify key columns for the main view
            // We try to match your Excel headers to our "Main" columns
            // You can customize this mapping
            const colMap = {
                status: allKeys.find(k => k.match(/status/i)) || allKeys[1],
                code: allKeys.find(k => k.match(/code/i)) || allKeys[3],
                name: allKeys.find(k => k.match(/name|desc/i)) || allKeys[7],
                cat: allKeys.find(k => k.match(/material|category/i)) || allKeys[2],
                vendor: allKeys.find(k => k.match(/vendor/i)) || allKeys[9]
            };

            rawData.forEach((row, idx) => {
                const item = {
                    id: row['ID'] || idx+1,
                    status: row[colMap.status] || 'Unknown',
                    code: row[colMap.code] || '-',
                    name: row[colMap.name] || 'Unnamed',
                    cat: row[colMap.cat] || 'General',
                    vendor: row[colMap.vendor] || 'Unknown',
                    remarks: row['Remarks'] || ''
                };

                // KPI
                if(String(item.status).toLowerCase().includes('in use')) active++; else discontinued++;
                if(item.vendor) vendors.add(item.vendor);

                // Grid Card
                const pillClass = String(item.status).toLowerCase().includes('in use') ? 'pill-active' : 'pill-inactive';
                const card = `
                <div class="item-card bg-white rounded-xl p-4 flex flex-col h-full search-item relative active:bg-slate-50 cursor-pointer" 
                     onclick="openModal(${idx})"
                     data-search="${Object.values(row).join(' ').toLowerCase()}">
                    
                    <div class="flex justify-between items-start mb-3">
                        <span class="pill ${pillClass}">${item.status}</span>
                        <span class="text-[10px] font-mono text-slate-400">#${item.id}</span>
                    </div>
                    
                    <h4 class="font-bold text-slate-800 text-sm leading-tight mb-2 line-clamp-2">${item.name}</h4>
                    <div class="text-[10px] text-slate-500 font-mono mb-3 bg-slate-50 inline-block px-1.5 py-0.5 rounded border border-slate-100 w-fit">${item.code}</div>
                    
                    <div class="space-y-1 mt-auto">
                        <div class="flex items-center text-xs text-slate-600">
                            <i class="fa-solid fa-layer-group w-5 text-slate-300"></i> <span class="truncate">${item.cat}</span>
                        </div>
                        <div class="flex items-center text-xs text-slate-600">
                            <i class="fa-solid fa-store w-5 text-slate-300"></i> <span class="truncate">${item.vendor}</span>
                        </div>
                    </div>
                </div>`;
                grid.append(card);
            });

            // KPIs
            $('#kpi-total').text(rawData.length);
            $('#kpi-active').text(active);
            $('#kpi-inactive').text(discontinued);
            $('#kpi-vendors').text(vendors.size);

            // 3. Initialize Dynamic DataTable
            initDynamicTable(allKeys);
        }

        function initDynamicTable(headers) {
            // Build THEAD
            let thHTML = '<thead><tr>';
            headers.forEach(h => {
                thHTML += `<th class="whitespace-nowrap px-4 py-3 bg-slate-50 text-xs font-bold text-slate-500 uppercase border-b border-slate-200">${h}</th>`;
            });
            thHTML += '<th class="px-4 py-3 bg-slate-50 border-b border-slate-200 text-right">ACTION</th></tr></thead>';
            $('#mainTable').html(thHTML);

            // Prepare Data for DataTable
            const dtData = rawData.map((row, i) => {
                const values = headers.map(h => row[h] || '');
                values.push(`<button onclick="openModal(${i})" class="text-blue-600 font-bold text-xs hover:underline">View</button>`);
                return values;
            });

            if(dataTableInst) dataTableInst.destroy();
            
            dataTableInst = $('#mainTable').DataTable({
                data: dtData,
                columns: [...headers.map(h => ({ title: h })), { title: "Action" }],
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'colvis',
                        text: '<i class="fa-solid fa-columns mr-1"></i> Columns',
                        className: 'shadow-sm',
                        collectionLayout: 'fixed two-column'
                    },
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fa-solid fa-file-excel mr-1"></i> Excel',
                        className: 'shadow-sm text-green-600'
                    }
                ],
                scrollX: true,
                pageLength: 20,
                language: { search: "", searchPlaceholder: "Search table..." }
            });

            // Hide some columns by default to keep it clean (heuristic: show first 6)
            dataTableInst.columns().every(function(idx) {
                if(idx > 6 && idx < headers.length) this.visible(false);
            });
        }

        function switchView(view) {
            if(view === 'table') {
                $('#tableView').removeClass('hidden'); $('#gridView').addClass('hidden');
                $('#btn-table').addClass('text-blue-600 bg-blue-50').removeClass('text-slate-500 hover:bg-slate-50');
                $('#btn-grid').removeClass('text-blue-600 bg-blue-50').addClass('text-slate-500 hover:bg-slate-50');
            } else {
                $('#tableView').addClass('hidden'); $('#gridView').removeClass('hidden');
                $('#btn-grid').addClass('text-blue-600 bg-blue-50').removeClass('text-slate-500 hover:bg-slate-50');
                $('#btn-table').removeClass('text-blue-600 bg-blue-50').addClass('text-slate-500 hover:bg-slate-50');
            }
        }

        function filterGrid(search) {
            search = search.toLowerCase();
            let count = 0;
            $('.search-item').each(function() {
                const sData = $(this).data('search');
                if(String(sData).includes(search)) {
                    $(this).removeClass('hidden'); count++;
                } else {
                    $(this).addClass('hidden');
                }
            });
            if(count === 0) $('#noResults').removeClass('hidden'); else $('#noResults').addClass('hidden');
        }

        // --- MODAL ---
        function openModal(index) {
            const row = rawData[index];
            const allKeys = Object.keys(row);
            
            // Heuristic for main fields
            const name = row['Item_Name'] || row['Item Name'] || Object.values(row)[7] || 'Item';
            const vendor = row['Vendor List 2::Vendor_Name'] || row['Vendor'] || '';
            const code = row['Item_Code'] || row['Item Code'] || '';
            const cat = row['Material List::Material_Detail'] || row['Category'] || '';
            
            $('#modalTitle').text(name);
            $('#modalVendor').text(vendor);
            $('#modalId').text('#' + (row['ID'] || index+1));
            $('#modalStatus').text(row['Status'] || '');
            $('#modalCode').text(code);
            $('#modalCat').text(cat);
            $('#modalPCode').text(row['Product_Code'] || '-');
            $('#modalRemarks').text(row['Remarks'] || 'No remarks.');

            // FULL DATA TABLE
            const tbody = $('#modalFullTable').empty();
            allKeys.forEach(key => {
                if(row[key]) {
                     tbody.append(`
                        <tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                            <td class="py-2 px-1 font-semibold text-slate-500 w-1/3 align-top">${key.replace(/_/g, ' ')}</td>
                            <td class="py-2 px-1 text-slate-800 break-words align-top font-mono text-xs">${row[key]}</td>
                        </tr>
                    `);
                }
            });

            $('#detailModal').removeClass('opacity-0 pointer-events-none');
            $('#modalPanel').removeClass('translate-y-10 sm:scale-95');
            $('body').addClass('modal-active');
        }

        function closeModal() {
            $('#detailModal').addClass('opacity-0 pointer-events-none');
            $('#modalPanel').addClass('translate-y-10 sm:scale-95');
            $('body').removeClass('modal-active');
        }
    </script>
</body>
</html>
