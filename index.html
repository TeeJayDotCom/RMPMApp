<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Master Pro</title>
    
    <!-- Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --surface: #ffffff;
            --background: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 5px;
            border: 2px solid var(--background);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Loader Animation */
        #loader {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out;
        }

        .loader-logo {
            font-size: 2rem;
            color: white;
            margin-bottom: 2rem;
            animation: pulse 2s infinite;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .progress-bar {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-top: 2rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Glass Morphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .glass-panel:hover {
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        /* Card Styling */
        .item-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .item-card:hover {
            border-color: var(--primary-light);
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.1);
        }

        .item-card:hover::before {
            transform: scaleX(1);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-success {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .badge-danger {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
        }

        /* Modal Animation */
        .modal-enter {
            animation: modalEnter 0.3s ease-out forwards;
        }

        .modal-exit {
            animation: modalExit 0.2s ease-in forwards;
        }

        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modalExit {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
        }

        /* Tabs */
        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            position: relative;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 1rem;
            right: 1rem;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 3px 3px 0 0;
        }

        /* Search Highlight */
        .highlight {
            background: linear-gradient(120deg, rgba(255, 255, 0, 0.3) 0%, rgba(255, 255, 0, 0.1) 100%);
            padding: 0 0.25rem;
            border-radius: 2px;
        }

        /* Toast Animation */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-slide-in {
            animation: slideInRight 0.3s ease-out forwards;
        }

        .toast-slide-out {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .item-card {
                padding: 1rem;
            }
            
            .glass-panel {
                border-radius: 12px;
            }
        }

        /* Utility */
        .text-gradient {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .shadow-soft {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Loading Screen -->
    <div id="loader">
        <div class="loader-logo">
            <i class="fas fa-boxes-stacked"></i>
        </div>
        <div class="spinner mb-4"></div>
        <h2 class="text-xl font-bold text-white mb-2">Loading Inventory</h2>
        <p class="text-white/80 text-sm mb-6">Initializing dashboard...</p>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-50">
        <div class="bg-gradient-to-r from-indigo-600 to-blue-600 text-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-xl backdrop-blur-sm">
                        <i class="fas fa-boxes-stacked text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-tight">Inventory Master</h1>
                        <p class="text-xs text-blue-100 font-medium uppercase tracking-wider opacity-90">Real-time Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="location.reload()" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-sm hover:bg-white/30 flex items-center justify-center transition-all duration-300" title="Refresh">
                        <i class="fas fa-rotate"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="bg-white shadow-soft">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 py-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-gradient" id="kpi-total">-</div>
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Total Items</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-green-600" id="kpi-active">-</div>
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Active</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-amber-600" id="kpi-pending">-</div>
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Discontinued</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600" id="kpi-vendors">-</div>
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Vendors</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full space-y-8">

        <!-- Charts Section -->
        <section id="dashboard-section" class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Status Chart -->
                <div class="glass-panel p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Inventory Status</h3>
                            <p class="text-sm text-gray-500" id="status-chart-desc">Overview of item status distribution</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center">
                            <i class="fas fa-chart-pie text-blue-600"></i>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- Category Chart -->
                <div class="glass-panel p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-gray-800 text-lg">Top Categories</h3>
                            <p class="text-sm text-gray-500" id="category-chart-desc">Most frequent material categories</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-50 to-pink-50 flex items-center justify-center">
                            <i class="fas fa-chart-bar text-purple-600"></i>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Search and Filters -->
        <div class="sticky top-32 z-30 -mx-4 px-4 sm:mx-0 sm:px-0 py-4 bg-gradient-to-b from-white via-white/95 to-transparent backdrop-blur-sm">
            <div class="space-y-4">
                <!-- Search Bar -->
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="searchInput" class="w-full pl-12 pr-32 py-4 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 placeholder-gray-400 font-medium shadow-soft transition-all duration-300" placeholder="Search items, codes, descriptions, vendors...">
                    <div id="search-badge" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 px-3 py-1.5 bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-lg text-xs font-bold whitespace-nowrap shadow-md">
                        <span id="result-count">0</span> matches
                    </div>
                </div>

                <!-- Filter Row -->
                <div class="flex flex-wrap gap-3">
                    <select id="vendorFilter" class="flex-1 min-w-[150px] bg-white border border-gray-200 text-sm font-semibold text-gray-700 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 outline-none shadow-soft cursor-pointer transition-all duration-300">
                        <option value="">All Vendors</option>
                    </select>
                    
                    <select id="catFilter" class="flex-1 min-w-[150px] bg-white border border-gray-200 text-sm font-semibold text-gray-700 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 outline-none shadow-soft cursor-pointer transition-all duration-300">
                        <option value="">All Categories</option>
                    </select>
                    
                    <select id="statusFilter" class="flex-1 min-w-[150px] bg-white border border-gray-200 text-sm font-semibold text-gray-700 rounded-lg py-2.5 px-3 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 outline-none shadow-soft cursor-pointer transition-all duration-300">
                        <option value="">All Status</option>
                        <option value="In Use">In Use</option>
                        <option value="Discontinued">Discontinued</option>
                    </select>
                    
                    <button onclick="clearFilters()" class="px-4 py-2.5 bg-gradient-to-r from-gray-100 to-gray-50 hover:from-gray-200 hover:to-gray-100 border border-gray-200 text-gray-700 font-semibold rounded-lg shadow-soft transition-all duration-300 flex items-center gap-2">
                        <i class="fas fa-filter-circle-xmark"></i>
                        <span>Clear</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <section id="results-area" class="min-h-[60vh]">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-bold text-gray-800">Inventory Items</h2>
                <div class="text-sm text-gray-500">
                    Showing <span id="visible-count">0</span> of <span id="total-count">0</span> items
                </div>
            </div>
            
            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Items will be dynamically inserted here -->
            </div>
            
            <div id="empty-state" class="flex flex-col items-center justify-center py-16 text-gray-400 hidden">
                <div class="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-50 rounded-full flex items-center justify-center mb-6">
                    <i class="fas fa-search text-4xl opacity-30"></i>
                </div>
                <h3 class="font-semibold text-lg mb-2">No items to display</h3>
                <p class="text-sm max-w-md text-center">Try adjusting your search or filters to find what you're looking for.</p>
            </div>
        </section>
    </main>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity duration-300" onclick="closeModal()"></div>
        <div class="bg-white w-full max-w-6xl rounded-2xl shadow-2xl relative flex flex-col max-h-[95vh] modal-enter">
            
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-100 flex justify-between items-start">
                <div class="flex-1 pr-8">
                    <div class="flex items-center gap-3 mb-3">
                        <span id="mId" class="text-xs font-mono bg-gray-100 text-gray-600 px-2 py-1 rounded">#ID</span>
                        <span id="mStatus" class="badge"></span>
                    </div>
                    <h2 id="mTitle" class="text-2xl font-bold text-gray-800 leading-tight mb-2">Item Name</h2>
                    <div class="flex items-center gap-4 text-sm">
                        <span id="mVendor" class="font-semibold text-blue-600 flex items-center gap-1">
                            <i class="fas fa-building"></i>
                            <span>Vendor</span>
                        </span>
                    </div>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-all duration-300 transform hover:rotate-90">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <!-- Modal Tabs -->
            <div class="flex border-b border-gray-100 bg-gray-50/50 px-6">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn active">Overview</button>
                <button onclick="switchTab('details')" id="tab-details" class="tab-btn">Details</button>
                <button onclick="switchTab('raw')" id="tab-raw" class="tab-btn">Raw Data</button>
            </div>

            <!-- Modal Content -->
            <div class="flex-grow overflow-y-auto p-6 custom-scrollbar">
                
                <!-- Overview Tab -->
                <div id="view-overview" class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100">
                            <p class="text-xs font-semibold text-blue-500 uppercase tracking-wide mb-1">Item Code</p>
                            <p id="mCode" class="text-lg font-bold text-blue-900 font-mono">-</p>
                        </div>
                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-xl border border-gray-200">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Category</p>
                            <p id="mCat" class="text-lg font-bold text-gray-800">-</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                            <i class="fas fa-sticky-note"></i>
                            <span>Remarks</span>
                        </h4>
                        <div class="bg-gradient-to-br from-amber-50 to-yellow-50 border border-amber-100 p-4 rounded-xl">
                            <p id="mRemarks" class="text-sm text-gray-700 leading-relaxed">No remarks provided.</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                            <i class="fas fa-info-circle"></i>
                            <span>Quick Details</span>
                        </h4>
                        <div class="grid grid-cols-2 gap-3" id="mQuickDetails"></div>
                    </div>
                </div>

                <!-- Details Tab -->
                <div id="view-details" class="hidden space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="mDetailGrid"></div>
                </div>

                <!-- Raw Data Tab -->
                <div id="view-raw" class="hidden">
                    <div class="bg-gray-50 rounded-lg overflow-hidden border border-gray-200">
                        <table class="w-full text-sm text-left">
                            <tbody id="mRawTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal Footer - Updated with narrower buttons -->
            <div class="p-4 border-t border-gray-100 bg-gray-50/50 rounded-b-2xl flex justify-end items-center">
                <div class="flex gap-2">
                    <button onclick="copyToWhatsApp()" class="px-3 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold rounded-lg shadow-sm transition-all duration-300 flex items-center gap-2">
                        <i class="fab fa-whatsapp"></i>
                        <span>Copy</span>
                    </button>
                    <button onclick="closeModal()" class="px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 font-semibold rounded-lg shadow-sm transition-all duration-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 right-6 z-50 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg shadow-lg transform translate-x-full transition-transform duration-300">
        <div class="flex items-center gap-3">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message">Operation completed</span>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            DEFAULT_FILE: 'RM.xlsx',
            ITEMS_PER_PAGE: 50,
            DEBOUNCE_DELAY: 300
        };

        // State Management
        const AppState = {
            inventory: [],
            filteredItems: [],
            activeFilters: {
                search: '',
                vendor: '',
                category: '',
                status: ''
            },
            charts: {},
            currentModalItem: null
        };

        // Initialize Application
        $(document).ready(() => {
            // Simulate loading progress
            simulateLoading();
            
            // Load data
            loadData(CONFIG.DEFAULT_FILE);
            
            // Set up event listeners
            initializeEventListeners();
        });

        // Loading Simulation
        function simulateLoading() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                $('#progressFill').css('width', `${progress}%`);
            }, 200);
        }

        // Data Loading
        async function loadData(filename) {
            try {
                const response = await fetch(`${filename}?t=${Date.now()}`);
                if (!response.ok) throw new Error('File not found');
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const rawData = XLSX.utils.sheet_to_json(worksheet);
                
                processInventoryData(rawData);
                showToast('Inventory data loaded successfully');
            } catch (error) {
                console.warn('Auto-load failed:', error);
                showToast('Failed to load inventory data', 'error');
            }
        }

        // Data Processing
        function processInventoryData(rawData) {
            AppState.inventory = rawData.map((row, index) => {
                const item = {
                    id: row['ID'] || index + 1,
                    status: row['Status'] || 'Unknown',
                    category: row['Material List::Material_Detail'] || row['Category'] || 'General',
                    code: row['Item_Code'] || row['Item Code'] || 'N/A',
                    name: row['Item_Name'] || row['Item Name'] || 'Unnamed Item',
                    vendor: row['Vendor List 2::Vendor_Name'] || row['Vendor'] || 'Unknown Vendor',
                    remarks: row['Remarks'] || '',
                    timestamp: row['Last_Updated'] || new Date().toISOString().split('T')[0],
                    rawData: row,
                    // CHANGED: Improved searchable text normalization
                    searchableText: Object.values(row)
                        .map(val => String(val || '').toLowerCase().replace(/\s+/g, ' '))
                        .join(' ')
                };
                
                // Add additional processed fields
                Object.keys(row).forEach(key => {
                    if (!['ID', 'Status', 'Category', 'Item_Code', 'Item_Name', 'Vendor', 'Remarks'].includes(key)) {
                        item[key] = row[key];
                    }
                });
                
                return item;
            });
            
            initializeDashboard();
            applyFilters();
            $('#loader').fadeOut(500);
        }

        // Dashboard Initialization
        function initializeDashboard() {
            updateKPIs();
            populateFilters();
            initializeCharts();
            updateCounts();
            
            // Show empty state initially
            updateEmptyState();
        }

        function updateKPIs() {
            const stats = {
                total: AppState.inventory.length,
                active: AppState.inventory.filter(i => i.status === 'In Use').length,
                discontinued: AppState.inventory.filter(i => i.status === 'Discontinued').length,
                vendors: new Set(AppState.inventory.map(i => i.vendor)).size
            };
            
            $('#kpi-total').text(stats.total.toLocaleString());
            $('#kpi-active').text(stats.active.toLocaleString());
            $('#kpi-pending').text(stats.discontinued.toLocaleString());
            $('#kpi-vendors').text(stats.vendors.toLocaleString());
        }

        // Two-way dependent filters
        function updateCategoryFilterByVendor(vendor) {
            const catFilter = $('#catFilter');
            const currentValue = catFilter.val();
            
            // Get unique categories for the selected vendor
            let categories;
            if (vendor) {
                categories = [...new Set(AppState.inventory
                    .filter(item => item.vendor === vendor && item.category)
                    .map(item => item.category))].sort();
            } else {
                categories = [...new Set(AppState.inventory
                    .filter(item => item.category)
                    .map(item => item.category))].sort();
            }
            
            // Update category dropdown
            catFilter.empty();
            catFilter.append('<option value="">All Categories</option>');
            categories.forEach(category => {
                catFilter.append(`<option value="${category}">${category}</option>`);
            });
            
            // Restore previous selection if still valid
            if (categories.includes(currentValue)) {
                catFilter.val(currentValue);
            } else if (currentValue) {
                catFilter.val('');
            }
        }

        function updateVendorFilterByCategory(category) {
            const vendorFilter = $('#vendorFilter');
            const currentValue = vendorFilter.val();
            
            // Get unique vendors for the selected category
            let vendors;
            if (category) {
                vendors = [...new Set(AppState.inventory
                    .filter(item => item.category === category && item.vendor)
                    .map(item => item.vendor))].sort();
            } else {
                vendors = [...new Set(AppState.inventory
                    .filter(item => item.vendor)
                    .map(item => item.vendor))].sort();
            }
            
            // Update vendor dropdown
            vendorFilter.empty();
            vendorFilter.append('<option value="">All Vendors</option>');
            vendors.forEach(vendor => {
                vendorFilter.append(`<option value="${vendor}">${vendor}</option>`);
            });
            
            // Restore previous selection if still valid
            if (vendors.includes(currentValue)) {
                vendorFilter.val(currentValue);
            } else if (currentValue) {
                vendorFilter.val('');
            }
        }

        function populateFilters() {
            // Initialize both filters with all values
            updateVendorFilterByCategory('');
            updateCategoryFilterByVendor('');
            
            // Add event listeners for two-way dependency
            $('#vendorFilter').off('change').on('change', function() {
                const selectedVendor = $(this).val();
                updateCategoryFilterByVendor(selectedVendor);
                applyFilters();
            });
            
            $('#catFilter').off('change').on('change', function() {
                const selectedCategory = $(this).val();
                updateVendorFilterByCategory(selectedCategory);
                applyFilters();
            });
        }

        // Charts
        function initializeCharts() {
            if (window.chartInstances) {
                window.chartInstances.forEach(chart => chart.destroy());
            }
            
            window.chartInstances = [];
            
            // Status Chart
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                const statusData = getStatusDistribution(AppState.inventory);
                window.chartInstances.push(new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: statusData.labels,
                        datasets: [{
                            data: statusData.values,
                            backgroundColor: ['#10b981', '#f59e0b'],
                            borderWidth: 0,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: {
                                        family: 'Plus Jakarta Sans',
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleFont: { family: 'Plus Jakarta Sans' },
                                bodyFont: { family: 'Plus Jakarta Sans' }
                            }
                        }
                    }
                }));
            }
            
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                const categoryData = getTopCategories(AppState.inventory, 8);
                window.chartInstances.push(new Chart(categoryCtx, {
                    type: 'bar',
                    data: {
                        labels: categoryData.labels,
                        datasets: [{
                            label: 'Items',
                            data: categoryData.values,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderRadius: 6,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        family: 'Plus Jakarta Sans'
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        family: 'Plus Jakarta Sans',
                                        size: 11
                                    }
                                }
                            }
                        }
                    }
                }));
            }
        }

        function updateCharts() {
            const dataToUse = AppState.filteredItems.length > 0 ? AppState.filteredItems : AppState.inventory;
            
            // Update status chart
            if (window.chartInstances && window.chartInstances[0]) {
                const statusData = getStatusDistribution(dataToUse);
                window.chartInstances[0].data.labels = statusData.labels;
                window.chartInstances[0].data.datasets[0].data = statusData.values;
                window.chartInstances[0].update();
                
                // Update chart description
                const descText = AppState.filteredItems.length === AppState.inventory.length 
                    ? 'Overview of item status distribution' 
                    : `Showing status for ${AppState.filteredItems.length} filtered items`;
                $('#status-chart-desc').text(descText);
            }
            
            // Update category chart
            if (window.chartInstances && window.chartInstances[1]) {
                const categoryData = getTopCategories(dataToUse, 8);
                window.chartInstances[1].data.labels = categoryData.labels;
                window.chartInstances[1].data.datasets[0].data = categoryData.values;
                window.chartInstances[1].update();
                
                // Update chart description
                const descText = AppState.filteredItems.length === AppState.inventory.length 
                    ? 'Most frequent material categories' 
                    : `Top categories in ${AppState.filteredItems.length} filtered items`;
                $('#category-chart-desc').text(descText);
            }
        }

        function getStatusDistribution(data) {
            const statusCounts = {
                'In Use': 0,
                'Discontinued': 0
            };
            
            data.forEach(item => {
                const status = item.status || 'Unknown';
                if (status === 'In Use' || status === 'Discontinued') {
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                }
            });
            
            // Remove entries with 0 count
            Object.keys(statusCounts).forEach(key => {
                if (statusCounts[key] === 0) delete statusCounts[key];
            });
            
            return {
                labels: Object.keys(statusCounts),
                values: Object.values(statusCounts)
            };
        }

        function getTopCategories(data, limit) {
            const categoryCounts = {};
            data.forEach(item => {
                const category = item.category || 'Unknown';
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            });
            
            const sorted = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit);
            
            return {
                labels: sorted.map(([cat]) => cat.length > 20 ? cat.substring(0, 20) + '...' : cat),
                values: sorted.map(([, count]) => count)
            };
        }

        // NEW FUNCTION: Fuzzy Search
        function fuzzySearch(item, searchTerm) {
            if (!searchTerm) return true;
            
            // Normalize search term
            const normalizedSearch = searchTerm.toLowerCase().replace(/\s+/g, ' ').trim();
            
            // Split search term into words
            const searchWords = normalizedSearch.split(/\s+/);
            
            // Combine all searchable fields
            const searchableText = item.searchableText || '';
            const itemName = item.name.toLowerCase() || '';
            const itemCode = item.code.toLowerCase() || '';
            const itemVendor = item.vendor.toLowerCase() || '';
            const itemCategory = item.category.toLowerCase() || '';
            const itemRemarks = (item.remarks || '').toLowerCase();
            
            // Combine all text
            const allText = `${searchableText} ${itemName} ${itemCode} ${itemVendor} ${itemCategory} ${itemRemarks}`;
            
            // Check if ALL search words appear in the text
            return searchWords.every(word => {
                // Skip very short words (optional)
                if (word.length < 2) return true;
                return allText.includes(word);
            });
        }

        // Filtering System
        let filterTimeout;
        function initializeEventListeners() {
            $('#searchInput').on('input', debounce(applyFilters, CONFIG.DEBOUNCE_DELAY));
            $('#statusFilter').on('change', applyFilters);
        }

        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(filterTimeout);
                    func(...args);
                };
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(later, wait);
            };
        }

        function applyFilters() {
            AppState.activeFilters = {
                search: $('#searchInput').val().toLowerCase().trim(),
                vendor: $('#vendorFilter').val(),
                category: $('#catFilter').val(),
                status: $('#statusFilter').val()
            };
            
            AppState.filteredItems = AppState.inventory.filter(item => {
                // CHANGED: Use fuzzy search instead of simple includes
                const matchesSearch = !AppState.activeFilters.search || 
                    fuzzySearch(item, AppState.activeFilters.search);
                
                const matchesVendor = !AppState.activeFilters.vendor || 
                    item.vendor === AppState.activeFilters.vendor;
                
                const matchesCategory = !AppState.activeFilters.category || 
                    item.category === AppState.activeFilters.category;
                
                const matchesStatus = !AppState.activeFilters.status || 
                    item.status === AppState.activeFilters.status;
                
                return matchesSearch && matchesVendor && matchesCategory && matchesStatus;
            });
            
            updateCharts();
            renderResults();
            updateSearchBadge();
            updateCounts();
            updateEmptyState();
        }

        function clearFilters() {
            $('#searchInput').val('');
            $('#vendorFilter').val('');
            $('#catFilter').val('');
            $('#statusFilter').val('');
            updateVendorFilterByCategory('');
            updateCategoryFilterByVendor('');
            applyFilters();
            showToast('Filters cleared');
        }

        function updateSearchBadge() {
            const count = AppState.filteredItems.length;
            const badge = $('#search-badge');
            const resultCount = $('#result-count');
            
            if (count > 0 && AppState.activeFilters.search) {
                resultCount.text(count.toLocaleString());
                badge.removeClass('hidden').addClass('flex');
            } else {
                badge.addClass('hidden').removeClass('flex');
            }
        }

        function updateCounts() {
            $('#total-count').text(AppState.inventory.length.toLocaleString());
            $('#visible-count').text(AppState.filteredItems.length.toLocaleString());
        }

        function updateEmptyState() {
            const emptyState = $('#empty-state');
            if (AppState.filteredItems.length === 0 && (AppState.activeFilters.search || AppState.activeFilters.vendor || AppState.activeFilters.category || AppState.activeFilters.status)) {
                emptyState.removeClass('hidden');
            } else {
                emptyState.addClass('hidden');
            }
        }

        // Results Rendering
        function renderResults() {
            const container = $('#results-grid');
            container.empty();
            
            if (AppState.filteredItems.length === 0) {
                return;
            }
            
            // Render limited items for performance
            const itemsToRender = AppState.filteredItems.slice(0, CONFIG.ITEMS_PER_PAGE);
            
            itemsToRender.forEach(item => {
                const card = createItemCard(item);
                container.append(card);
            });
            
            // Show "load more" if there are more items
            if (AppState.filteredItems.length > CONFIG.ITEMS_PER_PAGE) {
                container.append(`
                    <div class="col-span-full text-center py-8">
                        <button onclick="loadMoreItems()" class="px-6 py-3 bg-gradient-to-r from-gray-100 to-gray-50 hover:from-gray-200 hover:to-gray-100 border border-gray-200 text-gray-700 font-semibold rounded-lg transition-all duration-300">
                            Load ${AppState.filteredItems.length - CONFIG.ITEMS_PER_PAGE} more items
                        </button>
                    </div>
                `);
            }
        }

        function createItemCard(item) {
            const statusClass = getStatusClass(item.status);
            const searchTerm = AppState.activeFilters.search;
            const highlightedName = highlightText(item.name, searchTerm);
            
            return `
                <div class="item-card" onclick="openModal('${item.id}')">
                    <div class="flex justify-between items-start mb-4">
                        <span class="badge ${statusClass}">${item.status}</span>
                        <span class="text-xs font-mono font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">${item.code}</span>
                    </div>
                    
                    <h3 class="font-bold text-gray-800 text-base leading-snug mb-3 line-clamp-2">${highlightedName}</h3>
                    
                    <div class="space-y-3 border-t border-gray-100 pt-3">
                        <div>
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Category</p>
                            <p class="text-sm font-medium text-gray-700">${item.category}</p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Vendor</p>
                            <p class="text-sm font-medium text-gray-700">${item.vendor}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between items-center">
                        <span class="text-xs text-gray-400 font-mono">#${item.id}</span>
                        <span class="text-sm font-semibold text-indigo-600 flex items-center gap-1">
                            View Details
                            <i class="fas fa-arrow-right text-xs"></i>
                        </span>
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'In Use': return 'badge-success';
                case 'Discontinued': return 'badge-danger';
                default: return 'badge-danger';
            }
        }

        // UPDATED: Better highlighting for multiple words
        function highlightText(text, searchTerm) {
            if (!searchTerm || !text) return text;
            
            // Split search term into words
            const searchWords = searchTerm.toLowerCase().split(/\s+/);
            let highlightedText = text;
            
            // Highlight each search word individually
            searchWords.forEach(word => {
                if (word.length > 2) { // Only highlight words with more than 2 characters
                    const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    highlightedText = highlightedText.replace(regex, '<span class="highlight">$1</span>');
                }
            });
            
            return highlightedText;
        }

        function loadMoreItems() {
            const container = $('#results-grid');
            const currentCount = container.children().length - 1; // Subtract load more button
            const nextItems = AppState.filteredItems.slice(currentCount, currentCount + CONFIG.ITEMS_PER_PAGE);
            
            nextItems.forEach(item => {
                const card = createItemCard(item);
                container.find('button').before(card);
            });
            
            // Update load more button or remove it
            const remaining = AppState.filteredItems.length - (currentCount + nextItems.length);
            if (remaining > 0) {
                container.find('button').text(`Load ${remaining} more items`);
            } else {
                container.find('button').remove();
            }
        }

        // Modal Functions
        function openModal(itemId) {
            const item = AppState.inventory.find(i => String(i.id) === String(itemId));
            if (!item) return;
            
            AppState.currentModalItem = item;
            
            // Populate modal with item data
            $('#mTitle').text(item.name);
            $('#mVendor').html(`<i class="fas fa-building"></i> ${item.vendor}`);
            $('#mId').text(`#${item.id}`);
            $('#mCode').text(item.code);
            $('#mCat').text(item.category);
            $('#mRemarks').text(item.remarks || 'No remarks provided.');
            
            // Update status badge
            const statusBadge = $('#mStatus');
            statusBadge.text(item.status);
            statusBadge.removeClass().addClass(`badge ${getStatusClass(item.status)}`);
            
            // Populate quick details
            populateQuickDetails(item);
            
            // Populate detail grid
            populateDetailGrid(item);
            
            // Populate raw data table
            populateRawDataTable(item);
            
            // Show modal with animation
            $('#detailModal').removeClass('hidden').addClass('flex');
            setTimeout(() => {
                $('#detailModal .modal-enter').addClass('modal-enter');
            }, 10);
            
            // Add escape key listener
            $(document).on('keydown.modal', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        }

        function closeModal() {
            $('#detailModal').removeClass('flex').addClass('hidden');
            $('#detailModal .modal-enter').removeClass('modal-enter');
            AppState.currentModalItem = null;
            $(document).off('keydown.modal');
        }

        function switchTab(tabName) {
            // Hide all tabs
            $('[id^="view-"]').addClass('hidden');
            $('.tab-btn').removeClass('active');
            
            // Show selected tab
            $(`#view-${tabName}`).removeClass('hidden');
            $(`#tab-${tabName}`).addClass('active');
        }

        function populateQuickDetails(item) {
            const container = $('#mQuickDetails');
            container.empty();
            
            const quickFields = [
                { label: 'Product Code', value: item.rawData['Product_Code'] },
                { label: 'Old Item Code', value: item.rawData['Old_Item_Code'] },
                { label: 'Product Detail', value: item.rawData['RM PM Product List 2::Product_Detail'] },
                { label: 'Item Detail', value: item.rawData['Item_Detail_by_Vendor'] }
            ];
            
            quickFields.forEach(field => {
                if (field.value) {
                    container.append(`
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs font-semibold text-gray-500 mb-1">${field.label}</p>
                            <p class="text-sm font-medium text-gray-800">${field.value}</p>
                        </div>
                    `);
                }
            });
        }

        function populateDetailGrid(item) {
            const container = $('#mDetailGrid');
            container.empty();
            
            const excludeFields = ['ID', 'Status', 'Material List::Material_Detail', 'Product_Code', 
                                 'RM PM Product List 2::Product_Detail', 'Item_Code', 'Old_Item_Code', 
                                 'Item_Name', 'Item_Detail_by_Vendor', 'Vendor List 2::Vendor_Name', 
                                 'Remarks'];
            
            Object.entries(item.rawData).forEach(([key, value]) => {
                if (value && !excludeFields.includes(key)) {
                    const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    container.append(`
                        <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-xl border border-gray-200">
                            <p class="text-xs font-semibold text-gray-600 mb-1">${formattedKey}</p>
                            <p class="text-sm text-gray-800 break-words">${value}</p>
                        </div>
                    `);
                }
            });
        }

        function populateRawDataTable(item) {
            const container = $('#mRawTable');
            container.empty();
            
            Object.entries(item.rawData).forEach(([key, value]) => {
                const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                container.append(`
                    <tr>
                        <td class="py-3 px-4 font-semibold text-gray-600 bg-gray-50">${formattedKey}</td>
                        <td class="py-3 px-4 text-gray-700">${value || '-'}</td>
                    </tr>
                `);
            });
        }

        // WhatsApp Copy Function
        function copyToWhatsApp() {
            if (!AppState.currentModalItem) return;
            
            const item = AppState.currentModalItem;
            
            // Create a fancy formatted message for WhatsApp
            let whatsappMessage = ` *INVENTORY ITEM DETAILS*\n`;
            whatsappMessage += `\n\n`;
            
            // Basic Information
            whatsappMessage += ` *Item ID:* ${item.id}\n`;
            whatsappMessage += ` *Status:* ${item.status}\n`;
            whatsappMessage += ` *Category:* ${item.category}\n`;
            whatsappMessage += ` *Item Code:* ${item.code}\n`;
            whatsappMessage += ` *Item Name:* ${item.name}\n`;
            whatsappMessage += ` *Vendor:* ${item.vendor}\n\n`;
            
            // Additional Details
            if (item.rawData['Old_Item_Code']) {
                whatsappMessage += ` *Previous Code:* ${item.rawData['Old_Item_Code']}\n`;
            }
            
            if (item.rawData['Product_Code']) {
                whatsappMessage += ` *Product Code:* ${item.rawData['Product_Code']}\n`;
            }
            
            if (item.rawData['RM PM Product List 2::Product_Detail']) {
                whatsappMessage += ` *Product Detail:* ${item.rawData['RM PM Product List 2::Product_Detail']}\n`;
            }
            
            if (item.rawData['Item_Detail_by_Vendor']) {
                whatsappMessage += ` *Vendor Detail:* ${item.rawData['Item_Detail_by_Vendor']}\n`;
            }
            
            // Remarks
            if (item.remarks) {
                whatsappMessage += `\n *Remarks:*\n${item.remarks}\n`;
            }
            
            whatsappMessage += `\n\n`;
            whatsappMessage += ` _Shared via Inventory Master Pro_`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(whatsappMessage).then(() => {
                showToast('Details copied for WhatsApp!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy details', 'error');
            });
        }

        // Utility Functions
        function showToast(message, type = 'success') {
            const toast = $('#toast');
            const toastMessage = $('#toast-message');
            
            // Set message and color based on type
            toastMessage.text(message);
            
            switch(type) {
                case 'success':
                    toast.css('background', 'linear-gradient(135deg, #10b981 0%, #34d399 100%)');
                    break;
                case 'warning':
                    toast.css('background', 'linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%)');
                    break;
                case 'error':
                    toast.css('background', 'linear-gradient(135deg, #ef4444 0%, #f87171 100%)');
                    break;
            }
            
            // Show toast with slide in
            toast.removeClass('toast-slide-out').addClass('toast-slide-in');
            toast.css('transform', 'translateX(0)');
            toast.css('opacity', '1');
            
            // Hide after 3 seconds with slide out
            setTimeout(() => {
                toast.removeClass('toast-slide-in').addClass('toast-slide-out');
                setTimeout(() => {
                    toast.css('transform', 'translateX(100%)');
                    toast.css('opacity', '0');
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
