<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RM Inventory App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #0f172a; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Mobile App Container Simulation */
        .app-container { max-width: 800px; margin: 0 auto; min-height: 100vh; background: #f8fafc; border-left: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; box-shadow: 0 0 20px rgba(0,0,0,0.03); display: flex; flex-direction: column; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #ffffff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Cards */
        .item-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: transform 0.15s; cursor: pointer; }
        .item-card:active { transform: scale(0.98); background-color: #f8fafc; }
        
        .label-sm { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.05em; margin-bottom: 2px; }
        .value-md { font-size: 13px; font-weight: 600; color: #334155; }

        /* Badges */
        .pill { padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .pill-active { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .pill-inactive { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        /* Modal */
        .modal { transition: opacity 0.2s ease-in-out; }
        .modal-card { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner mb-4"></div>
        <h2 class="text-lg font-bold text-slate-800">Loading App...</h2>
        <div id="error-msg" class="hidden mt-4 text-center">
            <p class="text-xs text-red-500 mb-2">Auto-load failed.</p>
            <label class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg cursor-pointer">
                Upload RM.xlsx
                <input type="file" id="manualFileInput" class="hidden" accept=".xlsx, .xls, .csv">
            </label>
        </div>
    </div>

    <div class="app-container">
        
        <header class="bg-white border-b border-slate-200 sticky top-0 z-30 px-4 h-16 flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white w-9 h-9 rounded-xl flex items-center justify-center shadow-blue-200 shadow-md">
                    <i class="fa-solid fa-cube text-sm"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-slate-800 leading-none">Inventory</h1>
                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Dashboard</span>
                </div>
            </div>
            <button onclick="location.reload()" class="w-9 h-9 rounded-full bg-slate-50 text-slate-400 hover:text-blue-600 flex items-center justify-center transition-colors">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </header>

        <div class="p-4 flex-grow overflow-y-auto">
            
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <p class="label-sm">Total Items</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-total">-</h3>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-green-500">
                    <p class="label-sm text-green-600">Active</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-active">-</h3>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-red-500">
                    <p class="label-sm text-red-600">Discontinued</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-inactive">-</h3>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <p class="label-sm text-blue-500">Vendors</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="kpi-vendors">-</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <h4 class="label-sm mb-2">Status Breakdown</h4>
                    <div class="h-40 relative">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                    <h4 class="label-sm mb-2">Top Categories</h4>
                    <div class="h-40 relative">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="sticky top-16 z-20 bg-[#f8fafc] py-2 mb-2">
                <div class="relative shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
                    </div>
                    <input type="text" id="searchInput" 
                           class="block w-full pl-11 pr-4 py-3.5 bg-white border border-slate-200 rounded-xl text-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow" 
                           placeholder="Search inventory to view items...">
                    <div id="searchCountBadge" class="hidden absolute inset-y-0 right-2 flex items-center">
                        <span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-md" id="searchCount">0</span>
                    </div>
                </div>
            </div>

            <div id="resultsArea" class="hidden animate-fade-in pb-10">
                <div class="flex justify-between items-center mb-3 px-1">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Search Results</span>
                </div>
                <div id="resultsContainer">
                    </div>
            </div>

            <div id="emptyState" class="text-center py-12">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300">
                    <i class="fa-solid fa-arrow-up text-2xl"></i>
                </div>
                <p class="text-sm text-slate-400 font-medium">Type above to find items</p>
            </div>

        </div>
    </div>

    <div id="detailModal" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="bg-white w-full h-[85vh] sm:h-[80vh] sm:max-w-2xl rounded-t-2xl sm:rounded-2xl shadow-2xl relative flex flex-col modal-card transform translate-y-full sm:scale-95">
            
            <div class="w-full flex justify-center pt-3 pb-1 sm:hidden" onclick="closeModal()">
                <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
            </div>

            <div class="p-5 border-b border-slate-100 flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span id="mId" class="text-[10px] font-mono bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">ID</span>
                        <span id="mStatus" class="pill"></span>
                    </div>
                    <h3 id="mTitle" class="text-xl font-bold text-slate-800 leading-tight pr-4">Item Name</h3>
                    <div id="mVendor" class="text-xs text-blue-600 font-bold mt-1 uppercase tracking-wide">Vendor</div>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:text-red-500 flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="flex border-b border-slate-200 px-5">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn active px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wide flex-1">Overview</button>
                <button onclick="switchTab('raw')" id="tab-raw" class="tab-btn px-4 py-3 text-xs font-bold text-slate-500 uppercase tracking-wide flex-1">Raw Data</button>
            </div>

            <div class="p-5 overflow-y-auto bg-white flex-grow">
                
                <div id="view-overview">
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                            <p class="label-sm text-blue-400">Code</p>
                            <p class="text-sm font-bold text-blue-900 font-mono" id="mCode">-</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <p class="label-sm">Category</p>
                            <p class="text-sm font-bold text-slate-800" id="mCat">-</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h4 class="label-sm mb-2">Remarks</h4>
                        <div class="bg-amber-50 border border-amber-100 rounded-xl p-3">
                            <p id="mRemarks" class="text-xs text-slate-700 italic">No remarks.</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="label-sm mb-3">Details</h4>
                        <div class="space-y-3" id="mCommon"></div>
                    </div>
                </div>

                <div id="view-raw" class="hidden">
                    <table class="w-full text-xs text-left">
                        <tbody id="mRawTable" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-slate-50 pb-safe">
                <button onclick="closeModal()" class="w-full bg-white border border-slate-300 text-slate-700 font-bold py-3 rounded-xl shadow-sm">Close</button>
            </div>
        </div>
    </div>

    <script>
        const FILENAME = 'RM.xlsx';
        let inventoryItems = [];
        let loadTimeout;

        // --- INIT ---
        $(document).ready(function() {
            attemptFetch();

            // Search Logic
            $('#searchInput').on('keyup', function() {
                const term = this.value.toLowerCase().trim();
                if(term.length > 0) {
                    performSearch(term);
                    $('#emptyState').hide();
                    $('#resultsArea').removeClass('hidden');
                } else {
                    $('#resultsContainer').empty();
                    $('#searchCountBadge').addClass('hidden');
                    $('#emptyState').show();
                    $('#resultsArea').addClass('hidden');
                }
            });

            $('#manualFileInput').on('change', function(e) {
                if(e.target.files[0]) processFile(e.target.files[0]);
            });
        });

        // --- DATA LOADING ---
        function attemptFetch() {
            loadTimeout = setTimeout(() => { $('#error-msg').removeClass('hidden'); }, 3000);
            fetch(FILENAME + '?v=' + new Date().getTime())
                .then(res => res.ok ? res.arrayBuffer() : Promise.reject())
                .then(ab => {
                    clearTimeout(loadTimeout);
                    const wb = XLSX.read(ab, {type:'array'});
                    processData(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
                })
                .catch(() => { /* Error handled by timeout UI */ });
        }

        function processFile(file) {
            const r = new FileReader();
            r.onload = e => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                processData(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
            };
            r.readAsArrayBuffer(file);
        }

        function processData(json) {
            // Map Data
            inventoryItems = json.map((row, index) => ({
                id: row['ID'] || index+1,
                status: row['Status'] || 'Unknown',
                cat: row['Material List::Material_Detail'] || row['Category'] || 'General',
                code: row['Item_Code'] || row['Item Code'] || '-',
                name: row['Item_Name'] || row['Item Name'] || 'Unnamed',
                vendor: row['Vendor List 2::Vendor_Name'] || row['Vendor'] || 'Unknown',
                remarks: row['Remarks'] || '',
                fullData: row,
                searchStr: (Object.values(row).join(' ')).toLowerCase() // Pre-compute search string
            }));

            updateDashboard();
            $('#loader').fadeOut();
        }

        // --- DASHBOARD & CHARTS ---
        function updateDashboard() {
            let active = 0, discontinued = 0;
            let vendors = new Set();
            let catCounts = {};

            inventoryItems.forEach(item => {
                if(String(item.status).toLowerCase().includes('in use')) active++; else discontinued++;
                if(item.vendor) vendors.add(item.vendor);
                catCounts[item.cat] = (catCounts[item.cat] || 0) + 1;
            });

            // Update KPI Text
            $('#kpi-total').text(inventoryItems.length);
            $('#kpi-active').text(active);
            $('#kpi-inactive').text(discontinued);
            $('#kpi-vendors').text(vendors.size);

            // Render Charts
            renderStatusChart(active, discontinued);
            renderCategoryChart(catCounts);
        }

        function renderStatusChart(active, inactive) {
            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Disc.'],
                    datasets: [{ data: [active, inactive], backgroundColor: ['#22c55e', '#ef4444'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true, font: {size: 10} } } } }
            });
        }

        function renderCategoryChart(counts) {
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 6);
            new Chart(document.getElementById('categoryChart'), {
                type: 'bar',
                data: {
                    labels: sorted.map(x => x[0]),
                    datasets: [{ data: sorted.map(x => x[1]), backgroundColor: '#3b82f6', borderRadius: 3 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { ticks: { display: false }, grid: { display: false } }, y: { display: false } }
                }
            });
        }

        // --- SEARCH & RENDER ---
        function performSearch(term) {
            const container = $('#resultsContainer');
            container.empty();
            let count = 0;

            // Simple Filter
            const results = inventoryItems.filter(item => item.searchStr.includes(term));
            count = results.length;

            // Render Max 50 to prevent lag
            results.slice(0, 50).forEach(item => {
                const isActive = String(item.status).toLowerCase().includes('in use');
                const pillClass = isActive ? 'pill-active' : 'pill-inactive';

                const html = `
                <div class="item-card" onclick="openModal(${item.id - 1})"> <div class="flex justify-between items-start mb-2">
                        <span class="pill ${pillClass}">${item.status}</span>
                        <span class="text-[10px] font-mono text-slate-400">#${item.id}</span>
                    </div>
                    <h4 class="text-sm font-bold text-slate-800 leading-snug mb-1">${item.name}</h4>
                    <div class="text-[10px] font-mono text-slate-500 mb-3 bg-slate-50 inline-block px-1.5 py-0.5 rounded border border-slate-100">${item.code}</div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <p class="label-sm">Category</p>
                            <p class="value-md truncate">${item.cat}</p>
                        </div>
                        <div>
                            <p class="label-sm">Vendor</p>
                            <p class="value-md truncate">${item.vendor}</p>
                        </div>
                    </div>
                </div>`;
                container.append(html);
            });

            // Update Counter
            $('#searchCount').text(count > 50 ? '50+' : count);
            $('#searchCountBadge').removeClass('hidden');
        }

        // --- MODAL ---
        function openModal(idx) {
            // Find item by ID logic or just direct index if mapped 1:1. 
            // Since we sorted/filtered, we need to find the object in the main array.
            // But here I passed (item.id - 1). Assuming ID matches index+1. 
            // Safer: pass the object itself? No, pass ID and find it.
            
            // Correction: performSearch slices results. Onclick passes (item.id -1). 
            // If data is sorted differently this breaks. 
            // Better: InventoryItems is original order. 
            
            const item = inventoryItems[idx]; // Assuming ID corresponds to index
            if(!item) return;

            $('#mTitle').text(item.name);
            $('#mVendor').text(item.vendor);
            $('#mId').text('#' + item.id);
            $('#mCode').text(item.code);
            $('#mCat').text(item.cat);
            $('#mRemarks').text(item.remarks || 'No remarks.');

            const stEl = $('#mStatus');
            stEl.text(item.status);
            stEl.removeClass('pill-active pill-inactive');
            if(String(item.status).toLowerCase().includes('in use')) stEl.addClass('pill-active');
            else stEl.addClass('pill-inactive');

            // Overview Common Fields
            const common = $('#mCommon').empty();
            const raw = $('#mRawTable').empty();
            const skip = ['Item_Name','Item Name','ID','Vendor','Vendor List 2::Vendor_Name','Remarks','Status','Material List::Material_Detail','Category','Item_Code','Item Code'];

            Object.keys(item.fullData).forEach(key => {
                const val = item.fullData[key];
                if(val) {
                    // Raw Data Tab
                    raw.append(`<tr><td class="py-2 pr-2 align-top text-slate-400 font-bold w-1/3">${key}</td><td class="py-2 align-top text-slate-700">${val}</td></tr>`);
                    
                    // Overview Tab (Extras)
                    if(!skip.includes(key) && key !== 'Product_Code') {
                        common.append(`
                            <div class="flex justify-between border-b border-slate-50 pb-1">
                                <span class="label-sm">${key.replace(/_/g,' ').substring(0,15)}</span>
                                <span class="text-xs text-slate-700 font-medium text-right">${val}</span>
                            </div>
                        `);
                    }
                }
            });

            switchTab('overview');
            $('#detailModal').removeClass('opacity-0 pointer-events-none');
            $('.modal-card').removeClass('translate-y-full sm:scale-95');
            $('body').addClass('modal-active');
        }

        function closeModal() {
            $('#detailModal').addClass('opacity-0 pointer-events-none');
            $('.modal-card').addClass('translate-y-full sm:scale-95');
            $('body').removeClass('modal-active');
        }

        function switchTab(t) {
            $('.tab-btn').removeClass('active');
            $(`#tab-${t}`).addClass('active');
            if(t === 'overview') { $('#view-overview').show(); $('#view-raw').hide(); }
            else { $('#view-overview').hide(); $('#view-raw').show(); }
        }

        document.onkeydown = function(evt) { if (evt.key === "Escape") closeModal(); };
    </script>
</body>
</html>
